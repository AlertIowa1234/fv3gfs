<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>GFS Physics Documentation: moninedmf.f Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ccpp_dox_extra_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ncep.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">GFS Physics Documentation
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('moninedmf_8f_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">moninedmf.f</div>  </div>
</div><!--header-->
<div class="contents">
<a href="moninedmf_8f.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keyword">      subroutine </span><a class="code" href="group___h_e_d_m_f.html#ga367b6dabfff601023af323f900db86d2">moninedmf</a>(ix,im,km,ntrac,ntcw,dv,du,tau,rtg,           &amp;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;     &amp;   u1,v1,t1,q1,swh,hlw,xmu,                                       &amp;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;     &amp;   psk,rbsoil,zorl,u10m,v10m,fm,fh,                               &amp;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;     &amp;   tsea,qss,heat,evap,stress,spd1,kpbl,                           &amp;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;     &amp;   prsi,del,prsl,prslk,phii,phil,delt,dspheat,                    &amp;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;     &amp;   dusfc,dvsfc,dtsfc,dqsfc,hpbl,hgamt,hgamq,dkt,                  &amp;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;     &amp;   kinver,xkzm_m,xkzm_h,xkzm_s,lprnt,ipr,                         &amp;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;     &amp;   xkzminv,moninq_fac)</div><div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="group___h_e_d_m_f.html#ga367b6dabfff601023af323f900db86d2">   97</a></span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      <span class="keywordtype">use </span>machine  <span class="keywordtype">, only</span> : kind_phys</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      <span class="keywordtype">use </span>funcphys <span class="keywordtype">, only</span> : fpvs</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;      <span class="keywordtype">use </span>physcons, grav =&gt; con_g, rd =&gt; con_rd, cp =&gt; con_cp</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;     &amp;,             hvap =&gt; con_hvap, fv =&gt; con_fvirt</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      <span class="keywordtype">implicit none</span></div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">!     arguments</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;      <span class="keywordtype">logical</span> lprnt</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      <span class="keywordtype">integer</span> ipr</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      <span class="keywordtype">integer</span> ix, im, km, ntrac, ntcw, kpbl(im), kinver(im)</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> delt, xkzm_m, xkzm_h, xkzm_s</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> dv(im,km),     du(im,km),                    &amp;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;     &amp;                     tau(im,km),    rtg(im,km,ntrac),             &amp;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;     &amp;                     u1(ix,km),     v1(ix,km),                    &amp;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;     &amp;                     t1(ix,km),     q1(ix,km,ntrac),              &amp;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;     &amp;                     swh(ix,km),    hlw(ix,km),                   &amp;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;     &amp;                     xmu(im),       psk(im),                      &amp;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;     &amp;                     rbsoil(im),    zorl(im),                     &amp;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;     &amp;                     u10m(im),      v10m(im),                     &amp;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;     &amp;                     fm(im),        fh(im),                       &amp;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;     &amp;                     tsea(im),      qss(im),                      &amp;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;     &amp;                                    spd1(im),                     &amp;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;     &amp;                     prsi(ix,km+1), del(ix,km),                   &amp;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;     &amp;                     prsl(ix,km),   prslk(ix,km),                 &amp;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;     &amp;                     phii(ix,km+1), phil(ix,km),                  &amp;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;     &amp;                     dusfc(im),     dvsfc(im),                    &amp;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;     &amp;                     dtsfc(im),     dqsfc(im),                    &amp;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;     &amp;                     hpbl(im),      hpblx(im),                    &amp;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;     &amp;                     hgamt(im),     hgamq(im)</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;      <span class="keywordtype">logical</span> dspheat</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">!          flag for tke dissipative heating</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">!    locals</span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <span class="keywordtype">integer</span> i,iprt,is,iun,k,kk,km1,kmpbl,latd,lond</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <span class="keywordtype">integer</span> lcld(im),icld(im),kcld(im),krad(im)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="keywordtype">integer</span> kx1(im), kpblx(im)</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">!     real(kind=kind_phys) betaq(im), betat(im),   betaw(im),</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> evap(im),  heat(im),    phih(im),            &amp;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;     &amp;                     phim(im),  rbdn(im),    rbup(im),            &amp;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;     &amp;                     stress(im),beta(im),    sflux(im),           &amp;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;     &amp;                     z0(im),    crb(im),     wstar(im),           &amp;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;     &amp;                     zol(im),   ustmin(im),  ustar(im),           &amp;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;     &amp;                     thermal(im),wscale(im), wscaleu(im)</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> theta(im,km),thvx(im,km),  thlvx(im,km),     &amp;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;     &amp;                     qlx(im,km),  thetae(im,km),                  &amp;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;     &amp;                     qtx(im,km),  bf(im,km-1),  diss(im,km),      &amp;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;     &amp;                     radx(im,km-1),                               &amp;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;     &amp;                     govrth(im),  hrad(im),                       &amp;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">!    &amp;                     hradm(im),   radmin(im),   vrad(im),         &amp;</span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;     &amp;                     radmin(im),  vrad(im),                       &amp;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;     &amp;                     zd(im),      zdd(im),      thlvx1(im) </div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> rdzt(im,km-1),dktx(im,km-1),                 &amp;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;     &amp;                     zi(im,km+1),  zl(im,km),    xkzo(im,km-1),   &amp;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;     &amp;                     dku(im,km-1), dkt(im,km-1), xkzmo(im,km-1),  &amp;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;     &amp;                     cku(im,km-1), ckt(im,km-1),                  &amp;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;     &amp;                     ti(im,km-1),  shr2(im,km-1),                 &amp;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;     &amp;                     al(im,km-1),  ad(im,km),                     &amp;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;     &amp;                     au(im,km-1),  a1(im,km),                     &amp;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;     &amp;                     a2(im,km*ntrac)</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> tcko(im,km),  qcko(im,km,ntrac),             &amp;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;     &amp;                     ucko(im,km),  vcko(im,km),  xmf(im,km)</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> prinv(im), rent(im)</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;      <span class="keywordtype">logical</span>  pblflg(im), sfcflg(im), scuflg(im), flg(im)</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      <span class="keywordtype">logical</span>  ublflg(im), pcnvflg(im)</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">!  pcnvflg: true for convective(strongly unstable) pbl</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">!  ublflg: true for unstable but not convective(strongly unstable) pbl</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> aphi16,  aphi5,  bvf2,   wfac,</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;     &amp;                     cfac,    conq,   cont,   conw,</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;     &amp;                     dk,      dkmax,  dkmin,</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;     &amp;                     dq1,     dsdz2,  dsdzq,  dsdzt,</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;     &amp;                     dsdzu,   dsdzv,</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;     &amp;                     dsig,    dt2,    dthe1,  dtodsd,</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;     &amp;                     dtodsu,  dw2,    dw2min, g,</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;     &amp;                     gamcrq,  gamcrt, gocp,</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;     &amp;                     gravi,   f0,</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;     &amp;                     prnum,   prmax,  prmin,  pfac,  crbcon,</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;     &amp;                     qmin,    tdzmin, qtend,  crbmin,crbmax,</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;     &amp;                     rbint,   rdt,    rdz,    qlmin,</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;     &amp;                     ri,      rimin,  rl2,    rlam,  rlamun,</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;     &amp;                     rone,    rzero,  sfcfrac,</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;     &amp;                     spdk2,   sri,    zol1,   zolcr, zolcru,</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;     &amp;                     robn,    ttend,</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;     &amp;                     utend,   vk,     vk2,</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;     &amp;                     ust3,    wst3,</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;     &amp;                     vtend,   zfac,   vpert,  cteit,</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;     &amp;                     rentf1,  rentf2, radfac,</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;     &amp;                     zfmin,   zk,     tem,    tem1,  tem2,</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;     &amp;                     xkzm,    xkzmu,  xkzminv,</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;     &amp;                     ptem,    ptem1,  ptem2, tx1(im), tx2(im)</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> moninq_fac</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> zstblmax,h1,     h2,     qlcr,  actei,</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;     &amp;                     cldtime</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;cc</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;      parameter(gravi=1.0/grav)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;      parameter(g=grav)</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;      parameter(gocp=g/cp)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      parameter(cont=cp/g,conq=hvap/g,conw=1.0/g)               <span class="comment">! for del in pa</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="comment">!     parameter(cont=1000.*cp/g,conq=1000.*hvap/g,conw=1000./g) ! for del in kpa</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      parameter(rlam=30.0,vk=0.4,vk2=vk*vk)</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      parameter(prmin=0.25,prmax=4.,zolcr=0.2,zolcru=-0.5)</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      parameter(dw2min=0.0001,dkmin=0.0,dkmax=1000.,rimin=-100.)</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      parameter(crbcon=0.25,crbmin=0.15,crbmax=0.35)</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      parameter(wfac=7.0,cfac=6.5,pfac=2.0,sfcfrac=0.1)</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">!     parameter(qmin=1.e-8,xkzm=1.0,zfmin=1.e-8,aphi5=5.,aphi16=16.)</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      parameter(qmin=1.e-8,         zfmin=1.e-8,aphi5=5.,aphi16=16.)</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      parameter(tdzmin=1.e-3,qlmin=1.e-12,f0=1.e-4)</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      parameter(h1=0.33333333,h2=0.66666667)</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">!     parameter(cldtime=500.,xkzminv=0.3)</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      parameter(cldtime=500.)</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">!     parameter(cldtime=500.,xkzmu=3.0,xkzminv=0.3)</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">!     parameter(gamcrt=3.,gamcrq=2.e-3,rlamun=150.0)</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;      parameter(gamcrt=3.,gamcrq=0.,rlamun=150.0)</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      parameter(rentf1=0.2,rentf2=1.0,radfac=0.85)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;      parameter(iun=84)</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">!     parameter (zstblmax = 2500., qlcr=1.0e-5)</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">!     parameter (zstblmax = 2500., qlcr=3.0e-5)</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">!     parameter (zstblmax = 2500., qlcr=3.5e-5)</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">!     parameter (zstblmax = 2500., qlcr=1.0e-4)</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;      parameter(zstblmax = 2500., qlcr=3.5e-5)</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">!     parameter (actei = 0.23)</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;      parameter(actei = 0.7)</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;c</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;c</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160; 601  <span class="keyword">format</span>(1x,<span class="stringliteral">&#39; moninp lat lon step hour &#39;</span>,3i6,f6.1)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; 602      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39;    k&#39;</span>,<span class="stringliteral">&#39;        z&#39;</span>,<span class="stringliteral">&#39;        t&#39;</span>,<span class="stringliteral">&#39;       th&#39;</span>,</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;     1     <span class="stringliteral">&#39;      tvh&#39;</span>,<span class="stringliteral">&#39;        q&#39;</span>,<span class="stringliteral">&#39;        u&#39;</span>,<span class="stringliteral">&#39;        v&#39;</span>,</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;     2     <span class="stringliteral">&#39;       sp&#39;</span>)</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; 603      <span class="keyword">format</span>(1x,i5,8f9.1)</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160; 604      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39;  sfc&#39;</span>,9x,f9.1,18x,f9.1)</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; 605      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39;    k      zl    spd2   thekv   the1v&#39;</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;     1         ,<span class="stringliteral">&#39; thermal    rbup&#39;</span>)</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; 606      <span class="keyword">format</span>(1x,i5,6f8.2)</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; 607      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39; kpbl    hpbl      fm      fh   hgamt&#39;</span>,</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;     1         <span class="stringliteral">&#39;   hgamq      ws   ustar      cd      ch&#39;</span>)</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160; 608      <span class="keyword">format</span>(1x,i5,9f8.2)</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160; 609      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39; k pr dkt dku &#39;</span>,i5,3f8.2)</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; 610      <span class="keyword">format</span>(1x,<span class="stringliteral">&#39; k pr dkt dku &#39;</span>,i5,3f8.2,<span class="stringliteral">&#39; l2 ri t2&#39;</span>,</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;     1         <span class="stringliteral">&#39; sr2  &#39;</span>,2f8.2,2e10.2)</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">! - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">! compute preliminary variables</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;      <span class="keywordflow">if</span> (ix .lt. im) stop</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">!     iprt = 0</span></div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">!     if(iprt.eq.1) then</span></div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">!cc   latd = 0</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">!     lond = 0</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">!     else</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">!cc   latd = 0</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">!     lond = 0</span></div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      dt2   = delt</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      rdt   = 1. / dt2</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;      km1   = km - 1</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;      kmpbl = km / 2</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="keywordflow">do</span> k=1,km</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;          zi(i,k) = phii(i,k) * gravi</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;          zl(i,k) = phil(i,k) * gravi</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;         zi(i,km+1) = phii(i,km+1) * gravi</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;          rdzt(i,k) = 1.0 / (zl(i,k+1) - zl(i,k))</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        kx1(i) = 1</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        tx1(i) = 1.0 / prsi(i,1)</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        tx2(i) = tx1(i)</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;          xkzo(i,k)  = 0.0</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;          xkzmo(i,k) = 0.0</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;          <span class="keywordflow">if</span> (k &lt; kinver(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">!                                  vertical background diffusivity</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            ptem      = prsi(i,k+1) * tx1(i)</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;            tem1      = 1.0 - ptem</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;            tem1      = tem1 * tem1 * 10.0</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;            xkzo(i,k) = xkzm_h * min(1.0, exp(-tem1))</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">!                                  vertical background diffusivity for momentum</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;            <span class="keywordflow">if</span> (ptem &gt;= xkzm_s) <span class="keywordflow">then</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;              xkzmo(i,k) = xkzm_m</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;              kx1(i)     = k + 1</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;              <span class="keywordflow">if</span> (k == kx1(i) .and. k &gt; 1) tx2(i) = 1.0 / prsi(i,k)</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;              tem1 = 1.0 - prsi(i,k+1) * tx2(i)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;              tem1 = tem1 * tem1 * 5.0</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;              xkzmo(i,k) = xkzm_m * min(1.0, exp(-tem1))</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">!     if (lprnt) then</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">!       print *,&#39; xkzo=&#39;,(xkzo(ipr,k),k=1,km1)</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">!       print *,&#39; xkzmo=&#39;,(xkzmo(ipr,k),k=1,km1)</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">!     endif</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">! diffusivity in the inversion layer is set to be xkzminv (m^2/s)</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;      <span class="keywordflow">do</span> k = 1,kmpbl</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">!         if(zi(i,k+1) &gt; 200..and.zi(i,k+1) &lt; zstblmax) then</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;          <span class="keywordflow">if</span>(zi(i,k+1) &gt; 250.) <span class="keywordflow">then</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;            tem1 = (t1(i,k+1)-t1(i,k)) * rdzt(i,k)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;            <span class="keywordflow">if</span>(tem1 &gt; 1.e-5) <span class="keywordflow">then</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;               xkzo(i,k)  = min(xkzo(i,k),xkzminv)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;         z0(i)    = 0.01 * zorl(i)</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;         dusfc(i) = 0.</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;         dvsfc(i) = 0.</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;         dtsfc(i) = 0.</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;         dqsfc(i) = 0.</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;         wscale(i)= 0.</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;         wscaleu(i)= 0.</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;         kpbl(i)  = 1</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;         hpbl(i)  = zi(i,1)</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;         hpblx(i) = zi(i,1)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;         pblflg(i)= .true.</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;         sfcflg(i)= .true.</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;         <span class="keywordflow">if</span>(rbsoil(i) &gt; 0.) sfcflg(i) = .false.</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;         ublflg(i)= .false.</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;         pcnvflg(i)= .false.</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;         scuflg(i)= .true.</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;         <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;           radmin(i)= 0.</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;           rent(i)  = rentf1</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;           hrad(i)  = zi(i,1)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">!          hradm(i) = zi(i,1)</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;           krad(i)  = 1</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;           icld(i)  = 0</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;           lcld(i)  = km1</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;           kcld(i)  = km1</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;           zd(i)    = 0.</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      <span class="keywordflow">do</span> k = 1,km</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;          theta(i,k) = t1(i,k) * psk(i) / prslk(i,k)</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;          qlx(i,k)   = max(q1(i,k,ntcw),qlmin)</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;          qtx(i,k)   = max(q1(i,k,1),qmin)+qlx(i,k)</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;          ptem       = qlx(i,k)</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;          ptem1      = hvap*max(q1(i,k,1),qmin)/(cp*t1(i,k))</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;          thetae(i,k)= theta(i,k)*(1.+ptem1)</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;          thvx(i,k)  = theta(i,k)*(1.+fv*max(q1(i,k,1),qmin)-ptem)</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;          ptem2      = theta(i,k)-(hvap/cp)*ptem</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;          thlvx(i,k) = ptem2*(1.+fv*qtx(i,k))</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;          dku(i,k)  = 0.</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;          dkt(i,k)  = 0.</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;          dktx(i,k) = 0.</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;          cku(i,k)  = 0.</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;          ckt(i,k)  = 0.</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;          tem       = zi(i,k+1)-zi(i,k)</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;          radx(i,k) = tem*(swh(i,k)*xmu(i)+hlw(i,k))</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;         flg(i)  = scuflg(i)</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      <span class="keywordflow">do</span> k = 1, km1</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;          <span class="keywordflow">if</span>(flg(i).and.zl(i,k) &gt;= zstblmax) <span class="keywordflow">then</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;             lcld(i)=k</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;             flg(i)=.false.</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!  compute virtual potential temp gradient (bf) and winshear square</span></div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      <span class="keywordflow">do</span> k = 1, km1</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;         rdz  = rdzt(i,k)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;         bf(i,k) = (thvx(i,k+1)-thvx(i,k))*rdz</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;         ti(i,k) = 2./(t1(i,k)+t1(i,k+1))</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;         dw2  = (u1(i,k)-u1(i,k+1))**2</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;     &amp;        + (v1(i,k)-v1(i,k+1))**2</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;         shr2(i,k) = max(dw2,dw2min)*rdz*rdz</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;        govrth(i) = g/theta(i,1)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;         beta(i)  = dt2 / (zi(i,2)-zi(i,1))</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;         ustar(i) = sqrt(stress(i))</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;         sflux(i)  = heat(i) + evap(i)*fv*theta(i,1)</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;         <span class="keywordflow">if</span>(.not.sfcflg(i) .or. sflux(i) &lt;= 0.) pblflg(i)=.false.</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;<span class="comment">!  compute the pbl height</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;         flg(i) = .false.</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;         rbup(i) = rbsoil(i)</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;         <span class="keywordflow">if</span>(pblflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;           thermal(i) = thvx(i,1)</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;           crb(i) = crbcon</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;           thermal(i) = tsea(i)*(1.+fv*max(q1(i,1,1),qmin))</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;           tem = sqrt(u10m(i)**2+v10m(i)**2)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;           tem = max(tem, 1.)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;           robn = tem / (f0 * z0(i))</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;           tem1 = 1.e-7 * robn</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;           crb(i) = 0.16 * (tem1 ** (-0.18))</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;           crb(i) = max(min(crb(i), crbmax), crbmin)</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;      <span class="keywordflow">do</span> k = 1, kmpbl</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">if</span>(.not.flg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;          rbdn(i) = rbup(i)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;          spdk2   = max((u1(i,k)**2+v1(i,k)**2),1.)</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;          rbup(i) = (thvx(i,k)-thermal(i))*</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;     &amp;              (g*zl(i,k)/thvx(i,1))/spdk2</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;          kpbl(i) = k</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;          flg(i)  = rbup(i) &gt; crb(i)</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <span class="keywordflow">if</span>(kpbl(i) &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;          k = kpbl(i)</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;          <span class="keywordflow">if</span>(rbdn(i) &gt;= crb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;            rbint = 0.</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;          <span class="keywordflow">elseif</span>(rbup(i) &lt;= crb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;            rbint = 1.</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;            rbint = (crb(i)-rbdn(i))/(rbup(i)-rbdn(i))</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;          hpbl(i) = zl(i,k-1) + rbint*(zl(i,k)-zl(i,k-1))</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;          <span class="keywordflow">if</span>(hpbl(i) &lt; zi(i,kpbl(i))) kpbl(i) = kpbl(i) - 1</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;          hpbl(i) = zl(i,1)</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;          kpbl(i) = 1</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;        kpblx(i) = kpbl(i)</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        hpblx(i) = hpbl(i)</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">!  compute similarity parameters</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;         zol(i) = max(rbsoil(i)*fm(i)*fm(i)/fh(i),rimin)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;         <span class="keywordflow">if</span>(sfcflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;           zol(i) = min(zol(i),-zfmin)</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;           zol(i) = max(zol(i),zfmin)</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;         zol1 = zol(i)*sfcfrac*hpbl(i)/zl(i,1)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;         <span class="keywordflow">if</span>(sfcflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">!          phim(i) = (1.-aphi16*zol1)**(-1./4.)</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">!          phih(i) = (1.-aphi16*zol1)**(-1./2.)</span></div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;           tem     = 1.0 / (1. - aphi16*zol1)</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;           phih(i) = sqrt(tem)</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;           phim(i) = sqrt(phih(i))</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;         <span class="keywordflow">else</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;           phim(i) = 1. + aphi5*zol1</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;           phih(i) = phim(i)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;         wscale(i) = ustar(i)/phim(i)</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;         ustmin(i) = ustar(i)/aphi5</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;         wscale(i) = max(wscale(i),ustmin(i))</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">if</span>(pblflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;          <span class="keywordflow">if</span>(zol(i) &lt; zolcru .and. kpbl(i) &gt; 1) <span class="keywordflow">then</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;            pcnvflg(i) = .true.</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;            ublflg(i) = .true.</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;          wst3 = govrth(i)*sflux(i)*hpbl(i)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;          wstar(i)= wst3**h1</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;          ust3 = ustar(i)**3.</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;          wscaleu(i) = (ust3+wfac*vk*wst3*sfcfrac)**h1</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;          wscaleu(i) = max(wscaleu(i),ustmin(i))</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">! compute counter-gradient mixing term for heat and moisture</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;         <span class="keywordflow">if</span>(ublflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;           hgamt(i)  = min(cfac*heat(i)/wscaleu(i),gamcrt)</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;           hgamq(i)  = min(cfac*evap(i)/wscaleu(i),gamcrq)</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;           vpert     = hgamt(i) + hgamq(i)*fv*theta(i,1)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;           vpert     = min(vpert,gamcrt)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;           thermal(i)= thermal(i)+max(vpert,0.)</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;           hgamt(i)  = max(hgamt(i),0.0)</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;           hgamq(i)  = max(hgamq(i),0.0)</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="comment">!  enhance the pbl height by considering the thermal excess</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;         flg(i)  = .true.</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;         <span class="keywordflow">if</span>(ublflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;           flg(i)  = .false.</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;           rbup(i) = rbsoil(i)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      <span class="keywordflow">do</span> k = 2, kmpbl</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">if</span>(.not.flg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;          rbdn(i) = rbup(i)</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;          spdk2   = max((u1(i,k)**2+v1(i,k)**2),1.)</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;          rbup(i) = (thvx(i,k)-thermal(i))*</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;     &amp;              (g*zl(i,k)/thvx(i,1))/spdk2</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;          kpbl(i) = k</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;          flg(i)  = rbup(i) &gt; crb(i)</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;        <span class="keywordflow">if</span>(ublflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;           k = kpbl(i)</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;           <span class="keywordflow">if</span>(rbdn(i) &gt;= crb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;              rbint = 0.</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;           <span class="keywordflow">elseif</span>(rbup(i) &lt;= crb(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;              rbint = 1.</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;           <span class="keywordflow">else</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;              rbint = (crb(i)-rbdn(i))/(rbup(i)-rbdn(i))</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;           hpbl(i) = zl(i,k-1) + rbint*(zl(i,k)-zl(i,k-1))</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;           <span class="keywordflow">if</span>(hpbl(i) &lt; zi(i,kpbl(i))) kpbl(i) = kpbl(i) - 1</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;           <span class="keywordflow">if</span>(kpbl(i) &lt;= 1) <span class="keywordflow">then</span></div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;              ublflg(i) = .false.</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;              pblflg(i) = .false.</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="comment">!  look for stratocumulus</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;        flg(i)=scuflg(i)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;      <span class="keywordflow">do</span> k = kmpbl,1,-1</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="keywordflow">if</span>(flg(i) .and. k &lt;= lcld(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;          <span class="keywordflow">if</span>(qlx(i,k).ge.qlcr) <span class="keywordflow">then</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;             kcld(i)=k</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;             flg(i)=.false.</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <span class="keywordflow">if</span>(scuflg(i) .and. kcld(i)==km1) scuflg(i)=.false.</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        flg(i)=scuflg(i)</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      <span class="keywordflow">do</span> k = kmpbl,1,-1</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="keywordflow">if</span>(flg(i) .and. k &lt;= kcld(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;          <span class="keywordflow">if</span>(qlx(i,k) &gt;= qlcr) <span class="keywordflow">then</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            <span class="keywordflow">if</span>(radx(i,k) &lt; radmin(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;              radmin(i)=radx(i,k)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;              krad(i)=k</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;            flg(i)=.false.</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        <span class="keywordflow">if</span>(scuflg(i) .and. krad(i) &lt;= 1) scuflg(i)=.false.</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">if</span>(scuflg(i) .and. radmin(i)&gt;=0.) scuflg(i)=.false.</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;        flg(i)=scuflg(i)</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;      <span class="keywordflow">do</span> k = kmpbl,2,-1</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;        <span class="keywordflow">if</span>(flg(i) .and. k &lt;= krad(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;          <span class="keywordflow">if</span>(qlx(i,k) &gt;= qlcr) <span class="keywordflow">then</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;            icld(i)=icld(i)+1</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;            flg(i)=.false.</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        <span class="keywordflow">if</span>(scuflg(i) .and. icld(i) &lt; 1) scuflg(i)=.false.</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;           hrad(i) = zi(i,krad(i)+1)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">!          hradm(i)= zl(i,krad(i))</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordflow">if</span>(scuflg(i) .and. hrad(i)&lt;zi(i,2)) scuflg(i)=.false.</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;        <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;          k    = krad(i)</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;          tem  = zi(i,k+1)-zi(i,k)</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;          tem1 = cldtime*radmin(i)/tem</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;          thlvx1(i) = thlvx(i,k)+tem1</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="comment">!         if(thlvx1(i) &gt; thlvx(i,k-1)) scuflg(i)=.false.</span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;         flg(i)=scuflg(i)</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      <span class="keywordflow">do</span> k = kmpbl,1,-1</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;        <span class="keywordflow">if</span>(flg(i) .and. k &lt;= krad(i))<span class="keywordflow">then</span></div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;          <span class="keywordflow">if</span>(thlvx1(i) &lt;= thlvx(i,k))<span class="keywordflow">then</span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;             tem=zi(i,k+1)-zi(i,k)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;             zd(i)=zd(i)+tem</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;             flg(i)=.false.</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;        <span class="keywordflow">if</span>(scuflg(i))<span class="keywordflow">then</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;          kk = max(1, krad(i)+1-icld(i))</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;          zdd(i) = hrad(i)-zi(i,kk)</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;        <span class="keywordflow">if</span>(scuflg(i))<span class="keywordflow">then</span></div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;          zd(i) = max(zd(i),zdd(i))</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;          zd(i) = min(zd(i),hrad(i))</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;          tem   = govrth(i)*zd(i)*(-radmin(i))</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;          vrad(i)= tem**h1</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;<span class="comment">!     compute inverse prandtl number</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        <span class="keywordflow">if</span>(ublflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;          tem = phih(i)/phim(i)+cfac*vk*sfcfrac</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;          tem = phih(i)/phim(i)</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        prinv(i) =  1.0 / tem</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        prinv(i) = min(prinv(i),prmax)</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        prinv(i) = max(prinv(i),prmin)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;        <span class="keywordflow">if</span>(zol(i) &gt; zolcr) <span class="keywordflow">then</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;          kpbl(i) = 1</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment">!     compute diffusion coefficients below pbl</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;      <span class="keywordflow">do</span> k = 1, kmpbl</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;         <span class="keywordflow">if</span>(k &lt; kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment">!           zfac = max((1.-(zi(i,k+1)-zl(i,1))/</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">!    1             (hpbl(i)-zl(i,1))), zfmin)</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;            zfac = max((1.-zi(i,k+1)/hpbl(i)), zfmin)</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;            tem = zi(i,k+1) * (zfac**pfac) * moninq_fac <span class="comment">! lmh suggested by kg</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;            <span class="keywordflow">if</span>(pblflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;              tem1 = vk * wscaleu(i) * tem</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment">!             dku(i,k) = xkzmo(i,k) + tem1</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment">!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;              dku(i,k) = tem1</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;              dkt(i,k) = tem1 * prinv(i)</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;            <span class="keywordflow">else</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;              tem1 = vk * wscale(i) * tem</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;<span class="comment">!             dku(i,k) = xkzmo(i,k) + tem1</span></div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="comment">!             dkt(i,k) = xkzo(i,k)  + tem1 * prinv(i)</span></div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;              dku(i,k) = tem1</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;              dkt(i,k) = tem1 * prinv(i)</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;            dku(i,k) = min(dku(i,k),dkmax)</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;            dku(i,k) = max(dku(i,k),xkzmo(i,k))</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;            dkt(i,k) = min(dkt(i,k),dkmax)</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;            dkt(i,k) = max(dkt(i,k),xkzo(i,k))</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            dktx(i,k)= dkt(i,k)</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="keywordflow">         endif</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;<span class="comment">! compute diffusion coefficients based on local scheme above pbl</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;      <span class="keywordflow">do</span> k = 1, km1</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;         <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;            <span class="keywordflow">if</span>(k &gt;= kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;               bvf2 = g*bf(i,k)*ti(i,k)</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;               ri   = max(bvf2/shr2(i,k),rimin)</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;               zk   = vk*zi(i,k+1)</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;               <span class="keywordflow">if</span>(ri &lt; 0.) <span class="keywordflow">then</span> <span class="comment">! unstable regime</span></div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                  rl2      = zk*rlamun/(rlamun+zk)</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                  dk       = rl2*rl2*sqrt(shr2(i,k))</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                  sri      = sqrt(-ri)</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="comment">!                 dku(i,k) = xkzmo(i,k) + dk*(1+8.*(-ri)/(1+1.746*sri))</span></div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;<span class="comment">!                 dkt(i,k) = xkzo(i,k)  + dk*(1+8.*(-ri)/(1+1.286*sri))</span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                  dku(i,k) = dk*(1+8.*(-ri)/(1+1.746*sri))</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                  dkt(i,k) = dk*(1+8.*(-ri)/(1+1.286*sri))</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;               <span class="keywordflow">else</span>             <span class="comment">! stable regime</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                  rl2      = zk*rlam/(rlam+zk)</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="comment">!!                tem      = rlam * sqrt(0.01*prsi(i,k))</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="comment">!!                rl2      = zk*tem/(tem+zk)</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;                  dk       = rl2*rl2*sqrt(shr2(i,k))</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                  tem1     = dk/(1+5.*ri)**2</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                  <span class="keywordflow">if</span>(k &gt;= kpblx(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                    prnum = 1.0 + 2.1*ri</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                    prnum = min(prnum,prmax)</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                  <span class="keywordflow">else</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                    prnum = 1.0</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keywordflow">                  endif</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="comment">!                 dku(i,k) = xkzmo(i,k) + tem1 * prnum</span></div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;<span class="comment">!                 dkt(i,k) = xkzo(i,k)  + tem1</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;                  dku(i,k) = tem1 * prnum</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;                  dkt(i,k) = tem1</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="keywordflow">               endif</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;               dku(i,k) = min(dku(i,k),dkmax)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;               dku(i,k) = max(dku(i,k),xkzmo(i,k))</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;               dkt(i,k) = min(dkt(i,k),dkmax)</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;               dkt(i,k) = max(dkt(i,k),xkzo(i,k))</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="keywordflow">         enddo</span></div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment">!  compute components for mass flux mixing by large thermals</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;      <span class="keywordflow">do</span> k = 1, km</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;        <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;          <span class="keywordflow">if</span>(pcnvflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;            tcko(i,k) = t1(i,k)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;            ucko(i,k) = u1(i,k)</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;            vcko(i,k) = v1(i,k)</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;            xmf(i,k) = 0.</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      <span class="keywordflow">do</span> kk = 1, ntrac</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      <span class="keywordflow">do</span> k = 1, km</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;          <span class="keywordflow">if</span>(pcnvflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;            qcko(i,k,kk) = q1(i,k,kk)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;      <span class="keyword">call </span><a class="code" href="group___h_e_d_m_f.html#ga5787e718b62c0502c0734303a16cd8ed">mfpbl</a>(im,ix,km,ntrac,dt2,pcnvflg,</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;     &amp;       zl,zi,thvx,q1,t1,u1,v1,hpbl,kpbl,</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;     &amp;       sflux,ustar,wstar,xmf,tcko,qcko,ucko,vcko)</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;<span class="comment">!  compute diffusion coefficients for cloud-top driven diffusion</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;<span class="comment">!  if the condition for cloud-top instability is met,</span></div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;<span class="comment">!    increase entrainment flux at cloud top</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;           k = krad(i)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;           tem = thetae(i,k) - thetae(i,k+1)</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;           tem1 = qtx(i,k) - qtx(i,k+1)</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;           <span class="keywordflow">if</span> (tem &gt; 0. .and. tem1 &gt; 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;             cteit= cp*tem/(hvap*tem1)</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;             <span class="keywordflow">if</span>(cteit &gt; actei) rent(i) = rentf2</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;<span class="keywordflow">           endif</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;        <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;           k = krad(i)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;           tem1  = max(bf(i,k),tdzmin)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;           ckt(i,k) = -rent(i)*radmin(i)/tem1</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;           cku(i,k) = ckt(i,k)</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;      <span class="keywordflow">do</span> k = 1, kmpbl</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;         <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;            <span class="keywordflow">if</span>(scuflg(i) .and. k &lt; krad(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;               tem1=hrad(i)-zd(i)</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;               tem2=zi(i,k+1)-tem1</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;               <span class="keywordflow">if</span>(tem2 &gt; 0.) <span class="keywordflow">then</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                  ptem= tem2/zd(i)</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                  <span class="keywordflow">if</span>(ptem.ge.1.) ptem= 1.</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                  ptem= tem2*ptem*sqrt(1.-ptem)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                  ckt(i,k) = radfac*vk*vrad(i)*ptem</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;                  cku(i,k) = 0.75*ckt(i,k)</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                  ckt(i,k) = max(ckt(i,k),dkmin)</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;                  ckt(i,k) = min(ckt(i,k),dkmax)</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;                  cku(i,k) = max(cku(i,k),dkmin)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;                  cku(i,k) = min(cku(i,k),dkmax)</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="keywordflow">               endif</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="keywordflow">            endif</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="keywordflow">         enddo</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;      <span class="keywordflow">do</span> k = 1, kmpbl</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;          <span class="keywordflow">if</span>(scuflg(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;             dkt(i,k) = dkt(i,k)+ckt(i,k)</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;             dku(i,k) = dku(i,k)+cku(i,k)</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;             dkt(i,k) = min(dkt(i,k),dkmax)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;             dku(i,k) = min(dku(i,k),dkmax)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;<span class="comment">!     compute tridiagonal matrix elements for heat and moisture</span></div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;         ad(i,1) = 1.</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;         a1(i,1) = t1(i,1)   + beta(i) * heat(i)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;         a2(i,1) = q1(i,1,1) + beta(i) * evap(i)</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;      <span class="keywordflow">if</span>(ntrac &gt;= 2) <span class="keywordflow">then</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        <span class="keywordflow">do</span> k = 2, ntrac</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;          is = (k-1) * km</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;          <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;            a2(i,1+is) = q1(i,1,k)</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;          dtodsd = dt2/del(i,k)</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;          dtodsu = dt2/del(i,k+1)</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;          dsig   = prsl(i,k)-prsl(i,k+1)</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;          rdz    = rdzt(i,k)</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;          tem1   = dsig * dkt(i,k) * rdz</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;          dsdz2     = tem1 * rdz</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;          au(i,k)   = -dtodsd*dsdz2</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;          al(i,k)   = -dtodsu*dsdz2</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;          <span class="keywordflow">if</span>(pcnvflg(i) .and. k &lt; kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;             tem2      = dsig * rdz</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;             ptem      = 0.5 * tem2 * xmf(i,k)</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;             ptem1     = dtodsd * ptem</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;             ptem2     = dtodsu * ptem</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;             ad(i,k)   = ad(i,k)-au(i,k)-ptem1</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;             ad(i,k+1) = 1.-al(i,k)+ptem2</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;             au(i,k)   = au(i,k)-ptem1</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;             al(i,k)   = al(i,k)+ptem2</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;             ptem      = tcko(i,k) + tcko(i,k+1)</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;             dsdzt     = tem1 * gocp</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;             a1(i,k)   = a1(i,k)+dtodsd*dsdzt-ptem1*ptem</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt+ptem2*ptem</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;             ptem      = qcko(i,k,1) + qcko(i,k+1,1)</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;             a2(i,k)   = a2(i,k) - ptem1 * ptem</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;             a2(i,k+1) = q1(i,k+1,1) + ptem2 * ptem</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;          <span class="keywordflow">elseif</span>(ublflg(i) .and. k &lt; kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;             ptem1 = dsig * dktx(i,k) * rdz</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;             tem   = 1.0 / hpbl(i)</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;             dsdzt = tem1 * gocp - ptem1 * hgamt(i) * tem</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;             dsdzq = - ptem1 * hgamq(i) * tem</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;             ad(i,k)   = ad(i,k)-au(i,k)</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;             ad(i,k+1) = 1.-al(i,k)</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;             a1(i,k)   = a1(i,k)+dtodsd*dsdzt</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;             a2(i,k)   = a2(i,k)+dtodsd*dsdzq</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;             a2(i,k+1) = q1(i,k+1,1)-dtodsu*dsdzq</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;             ad(i,k)   = ad(i,k)-au(i,k)</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;             ad(i,k+1) = 1.-al(i,k)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;             dsdzt     = tem1 * gocp</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;             a1(i,k)   = a1(i,k)+dtodsd*dsdzt</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;             a1(i,k+1) = t1(i,k+1)-dtodsu*dsdzt</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;             a2(i,k+1) = q1(i,k+1,1)</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;      <span class="keywordflow">if</span>(ntrac &gt;= 2) <span class="keywordflow">then</span></div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;        <span class="keywordflow">do</span> kk = 2, ntrac</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;          is = (kk-1) * km</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;          <span class="keywordflow">do</span> k = 1, km1</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;            <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;              <span class="keywordflow">if</span>(pcnvflg(i) .and. k &lt; kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                dtodsd = dt2/del(i,k)</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                dtodsu = dt2/del(i,k+1)</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                dsig  = prsl(i,k)-prsl(i,k+1)</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                tem   = dsig * rdzt(i,k)</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                ptem  = 0.5 * tem * xmf(i,k)</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                ptem1 = dtodsd * ptem</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;                ptem2 = dtodsu * ptem</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                tem1  = qcko(i,k,kk) + qcko(i,k+1,kk)</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                a2(i,k+is) = a2(i,k+is) - ptem1*tem1</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                a2(i,k+1+is)= q1(i,k+1,kk) + ptem2*tem1</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;              <span class="keywordflow">else</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                a2(i,k+1+is) = q1(i,k+1,kk)</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;<span class="keywordflow">              endif</span></div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="comment">!     solve tridiagonal problem for heat and moisture</span></div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;      <span class="keyword">call </span><a class="code" href="moninedmf_8f.html#ab77885fe7ace4ef00558157788778408">tridin</a>(im,km,ntrac,al,ad,au,a1,a2,au,a1,a2)</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="comment">!     recover tendencies of heat and moisture</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;      <span class="keywordflow">do</span>  k = 1,km</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;         <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;            ttend      = (a1(i,k)-t1(i,k)) * rdt</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;            qtend      = (a2(i,k)-q1(i,k,1))*rdt</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            tau(i,k)   = tau(i,k)+ttend</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            rtg(i,k,1) = rtg(i,k,1)+qtend</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;            dtsfc(i)   = dtsfc(i)+cont*del(i,k)*ttend</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;            dqsfc(i)   = dqsfc(i)+conq*del(i,k)*qtend</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;<span class="keywordflow">         enddo</span></div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;      <span class="keywordflow">if</span>(ntrac &gt;= 2) <span class="keywordflow">then</span></div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordflow">do</span> kk = 2, ntrac</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;          is = (kk-1) * km</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;          <span class="keywordflow">do</span> k = 1, km</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;              qtend = (a2(i,k+is)-q1(i,k,kk))*rdt</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;              rtg(i,k,kk) = rtg(i,k,kk)+qtend</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;<span class="keywordflow">            enddo</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;<span class="comment">!   compute tke dissipation rate</span></div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;      <span class="keywordflow">if</span>(dspheat) <span class="keywordflow">then</span></div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;          diss(i,k) = dku(i,k)*shr2(i,k)-g*ti(i,k)*dkt(i,k)*bf(i,k)</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;<span class="comment">!         diss(i,k) = dku(i,k)*shr2(i,k)</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="comment">!     add dissipative heating at the first model layer</span></div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;      <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;         tem   = govrth(i)*sflux(i)</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;         tem1  = tem + stress(i)*spd1(i)/zl(i,1)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;         tem2  = 0.5 * (tem1+diss(i,1))</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;         tem2  = max(tem2, 0.)</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;         ttend = tem2 / cp</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;         tau(i,1) = tau(i,1)+0.5*ttend</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;<span class="comment">!     add dissipative heating above the first model layer</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;      <span class="keywordflow">do</span> k = 2,km1</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;          tem = 0.5 * (diss(i,k-1)+diss(i,k))</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;          tem  = max(tem, 0.)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;          ttend = tem / cp</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;          tau(i,k) = tau(i,k) + 0.5*ttend</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;<span class="comment">!     compute tridiagonal matrix elements for momentum</span></div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;      <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;         ad(i,1) = 1.0 + beta(i) * stress(i) / spd1(i)</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;         a1(i,1) = u1(i,1)</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;         a2(i,1) = v1(i,1)</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;      <span class="keywordflow">do</span> k = 1,km1</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        <span class="keywordflow">do</span> i=1,im</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;          dtodsd  = dt2/del(i,k)</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;          dtodsu  = dt2/del(i,k+1)</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;          dsig    = prsl(i,k)-prsl(i,k+1)</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;          rdz     = rdzt(i,k)</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;          tem1    = dsig*dku(i,k)*rdz</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;          dsdz2   = tem1 * rdz</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;          au(i,k) = -dtodsd*dsdz2</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;          al(i,k) = -dtodsu*dsdz2</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;          <span class="keywordflow">if</span>(pcnvflg(i) .and. k &lt; kpbl(i)) <span class="keywordflow">then</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;             tem2      = dsig * rdz</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;             ptem      = 0.5 * tem2 * xmf(i,k)</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;             ptem1     = dtodsd * ptem</div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;             ptem2     = dtodsu * ptem</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;             ad(i,k)   = ad(i,k)-au(i,k)-ptem1</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;             ad(i,k+1) = 1.-al(i,k)+ptem2</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;             au(i,k)   = au(i,k)-ptem1</div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;             al(i,k)   = al(i,k)+ptem2</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;             ptem      = ucko(i,k) + ucko(i,k+1)</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;             a1(i,k)   = a1(i,k) - ptem1 * ptem</div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;             a1(i,k+1) = u1(i,k+1) + ptem2 * ptem</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;             ptem      = vcko(i,k) + vcko(i,k+1)</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;             a2(i,k)   = a2(i,k) - ptem1 * ptem</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;             a2(i,k+1) = v1(i,k+1) + ptem2 * ptem</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;             ad(i,k)   = ad(i,k)-au(i,k)</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;             ad(i,k+1) = 1.-al(i,k)</div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;             a1(i,k+1) = u1(i,k+1)</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;             a2(i,k+1) = v1(i,k+1)</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="comment">!     solve tridiagonal problem for momentum</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;      <span class="keyword">call </span><a class="code" href="group___h_e_d_m_f.html#ga80bebdc639adaba3ed0ed2ea2f24315e">tridi2</a>(im,km,al,ad,au,a1,a2,au,a1,a2)</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="comment">!     recover tendencies of momentum</span></div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;      <span class="keywordflow">do</span> k = 1,km</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;         <span class="keywordflow">do</span> i = 1,im</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;            utend = (a1(i,k)-u1(i,k))*rdt</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;            vtend = (a2(i,k)-v1(i,k))*rdt</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;            du(i,k)  = du(i,k)  + utend</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;            dv(i,k)  = dv(i,k)  + vtend</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;            dusfc(i) = dusfc(i) + conw*del(i,k)*utend</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;            dvsfc(i) = dvsfc(i) + conw*del(i,k)*vtend</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="comment">!  for dissipative heating for ecmwf model</span></div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="comment">!           tem1 = 0.5*(a1(i,k)+u1(i,k))</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="comment">!           tem2 = 0.5*(a2(i,k)+v1(i,k))</span></div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;<span class="comment">!           diss(i,k) = -(tem1*utend+tem2*vtend)</span></div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;<span class="comment">!           diss(i,k) = max(diss(i,k),0.)</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;<span class="comment">!           ttend = diss(i,k) / cp</span></div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;<span class="comment">!           tau(i,k) = tau(i,k) + ttend</span></div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="keywordflow">         enddo</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;      <span class="keywordflow">do</span> i = 1, im</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;         hpbl(i) = hpblx(i)</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;         kpbl(i) = kpblx(i)</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;<span class="comment">!</span></div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;      <span class="keywordflow">return</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;<span class="keyword">      end</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;<span class="keyword">      subroutine </span><a class="code" href="group___h_e_d_m_f.html#ga80bebdc639adaba3ed0ed2ea2f24315e">tridi2</a>(l,n,cl,cm,cu,r1,r2,au,a1,a2)             </div><div class="line"><a name="l01200"></a><span class="lineno"><a class="line" href="group___h_e_d_m_f.html#ga80bebdc639adaba3ed0ed2ea2f24315e"> 1200</a></span>&#160;cc</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;      <span class="keywordtype">use </span>machine     <span class="keywordtype">, only</span> : kind_phys</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;      <span class="keywordtype">implicit none</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;      <span class="keywordtype">integer</span>             k,n,l,i</div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> fk</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;cc</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> cl(l,2:n),cm(l,n),cu(l,n-1),r1(l,n),r2(l,n),        &amp;</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;     &amp;          au(l,n-1),a1(l,n),a2(l,n)</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;      <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        fk      = 1./cm(i,1)</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        au(i,1) = fk*cu(i,1)</div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        a1(i,1) = fk*r1(i,1)</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        a2(i,1) = fk*r2(i,1)</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;      <span class="keywordflow">do</span> k=2,n-1</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;          fk      = 1./(cm(i,k)-cl(i,k)*au(i,k-1))</div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;          au(i,k) = fk*cu(i,k)</div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;          a1(i,k) = fk*(r1(i,k)-cl(i,k)*a1(i,k-1))</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;          a2(i,k) = fk*(r2(i,k)-cl(i,k)*a2(i,k-1))</div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;      <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        fk      = 1./(cm(i,n)-cl(i,n)*au(i,n-1))</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;        a1(i,n) = fk*(r1(i,n)-cl(i,n)*a1(i,n-1))</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        a2(i,n) = fk*(r2(i,n)-cl(i,n)*a2(i,n-1))</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;      <span class="keywordflow">do</span> k=n-1,1,-1</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;          a1(i,k) = a1(i,k)-au(i,k)*a1(i,k+1)</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;          a2(i,k) = a2(i,k)-au(i,k)*a2(i,k+1)</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;      <span class="keywordflow">return</span></div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="keyword">      end</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="keyword">      subroutine </span><a class="code" href="moninedmf_8f.html#ab77885fe7ace4ef00558157788778408">tridin</a>(l,n,nt,cl,cm,cu,r1,r2,au,a1,a2)</div><div class="line"><a name="l01243"></a><span class="lineno"><a class="line" href="moninedmf_8f.html#ab77885fe7ace4ef00558157788778408"> 1243</a></span>&#160;cc</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;      <span class="keywordtype">use </span>machine     <span class="keywordtype">, only</span> : kind_phys</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;      <span class="keywordtype">implicit none</span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;      <span class="keywordtype">integer</span>             is,k,kk,n,nt,l,i</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> fk(l)</div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;cc</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;      <span class="keywordtype">real(kind=kind_phys)</span> cl(l,2:n), cm(l,n), cu(l,n-1),               &amp;</div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;     &amp;                     r1(l,n),   r2(l,n*nt),                       &amp;</div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;     &amp;                     au(l,n-1), a1(l,n), a2(l,n*nt),              &amp;</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;     &amp;                     fkk(l,2:n-1)</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;      <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        fk(i)   = 1./cm(i,1)</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        au(i,1) = fk(i)*cu(i,1)</div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        a1(i,1) = fk(i)*r1(i,1)</div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;      <span class="keywordflow">do</span> k = 1, nt</div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        is = (k-1) * n</div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="keywordflow">do</span> i = 1, l</div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;          a2(i,1+is) = fk(i) * r2(i,1+is)</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;      <span class="keywordflow">do</span> k=2,n-1</div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;        <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;          fkk(i,k) = 1./(cm(i,k)-cl(i,k)*au(i,k-1))</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;          au(i,k)  = fkk(i,k)*cu(i,k)</div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;          a1(i,k)  = fkk(i,k)*(r1(i,k)-cl(i,k)*a1(i,k-1))</div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;      <span class="keywordflow">do</span> kk = 1, nt</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        is = (kk-1) * n</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <span class="keywordflow">do</span> k=2,n-1</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;          <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            a2(i,k+is) = fkk(i,k)*(r2(i,k+is)-cl(i,k)*a2(i,k+is-1))</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;      <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        fk(i)   = 1./(cm(i,n)-cl(i,n)*au(i,n-1))</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        a1(i,n) = fk(i)*(r1(i,n)-cl(i,n)*a1(i,n-1))</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;      <span class="keywordflow">do</span> k = 1, nt</div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        is = (k-1) * n</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <span class="keywordflow">do</span> i = 1, l</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;          a2(i,n+is) = fk(i)*(r2(i,n+is)-cl(i,n)*a2(i,n+is-1))</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;      <span class="keywordflow">do</span> k=n-1,1,-1</div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;        <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;          a1(i,k) = a1(i,k) - au(i,k)*a1(i,k+1)</div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;      <span class="keywordflow">do</span> kk = 1, nt</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;        is = (kk-1) * n</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;        <span class="keywordflow">do</span> k=n-1,1,-1</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;          <span class="keywordflow">do</span> i=1,l</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;            a2(i,k+is) = a2(i,k+is) - au(i,k)*a2(i,k+is+1)</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;c-----------------------------------------------------------------------</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;      <span class="keywordflow">return</span></div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="keyword">      end</span></div><div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div><div class="ttc" id="group___h_e_d_m_f_html_ga367b6dabfff601023af323f900db86d2"><div class="ttname"><a href="group___h_e_d_m_f.html#ga367b6dabfff601023af323f900db86d2">moninedmf</a></div><div class="ttdeci">subroutine moninedmf(ix, im, km, ntrac, ntcw, dv, du, tau, rtg, u1, v1, t1, q1, swh, hlw, xmu, psk, rbsoil, zorl, u10m, v10m, fm, fh, tsea, qss, heat, evap, stress, spd1, kpbl, prsi, del, prsl, prslk, phii, phil, delt, dspheat, dusfc, dvsfc, dtsfc, dqsfc, hpbl, hgamt, hgamq, dkt, kinver, xkzm_m, xkzm_h, xkzm_s, lprnt, ipr, xkzminv, moninq_fac)</div><div class="ttdoc">This subroutine contains all of logic for the Hybrid EDMF PBL scheme except for the calculation of th...</div><div class="ttdef"><b>Definition:</b> <a href="moninedmf_8f_source.html#l00097">moninedmf.f:97</a></div></div>
<div class="ttc" id="group___h_e_d_m_f_html_ga80bebdc639adaba3ed0ed2ea2f24315e"><div class="ttname"><a href="group___h_e_d_m_f.html#ga80bebdc639adaba3ed0ed2ea2f24315e">tridi2</a></div><div class="ttdeci">subroutine tridi2(l, n, cl, cm, cu, r1, r2, au, a1, a2)</div><div class="ttdoc">Routine to solve the tridiagonal system to calculate temperature and moisture at ; part of two-part p...</div><div class="ttdef"><b>Definition:</b> <a href="moninedmf_8f_source.html#l01200">moninedmf.f:1200</a></div></div>
<div class="ttc" id="group___h_e_d_m_f_html_ga5787e718b62c0502c0734303a16cd8ed"><div class="ttname"><a href="group___h_e_d_m_f.html#ga5787e718b62c0502c0734303a16cd8ed">mfpbl</a></div><div class="ttdeci">subroutine mfpbl(im, ix, km, ntrac, delt, cnvflg, zl, zm, thvx, q1, t1, u1, v1, hpbl, kpbl, sflx, ustar, wstar, xmf, tcko, qcko, ucko, vcko)</div><div class="ttdoc">This subroutine is used for calculating the mass flux and updraft properties. </div><div class="ttdef"><b>Definition:</b> <a href="mfpbl_8f_source.html#l00041">mfpbl.f:41</a></div></div>
<div class="ttc" id="moninedmf_8f_html_ab77885fe7ace4ef00558157788778408"><div class="ttname"><a href="moninedmf_8f.html#ab77885fe7ace4ef00558157788778408">tridin</a></div><div class="ttdeci">subroutine tridin(l, n, nt, cl, cm, cu, r1, r2, au, a1, a2)</div><div class="ttdoc">Routine to solve the tridiagonal system to calculate u- and v-momentum at ; part of two-part process ...</div><div class="ttdef"><b>Definition:</b> <a href="moninedmf_8f_source.html#l01243">moninedmf.f:1243</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="moninedmf_8f.html">moninedmf.f</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
